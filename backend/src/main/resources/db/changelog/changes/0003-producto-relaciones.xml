<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
    http://www.liquibase.org/xml/ns/dbchangelog
     https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.29.xsd">

  <!-- 1) Columna categoria_id -->
  <changeSet id="0003-001-add-producto-categoria-id" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists tableName="producto"/>
        <not>
          <columnExists tableName="producto" columnName="categoria_id"/>
        </not>
      </and>
    </preConditions>

    <addColumn tableName="producto">
      <column name="categoria_id" type="bigint"/>
    </addColumn>
  </changeSet>

  <!-- 2) Columna marca_id -->
  <changeSet id="0003-002-add-producto-marca-id" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists tableName="producto"/>
        <not>
          <columnExists tableName="producto" columnName="marca_id"/>
        </not>
      </and>
    </preConditions>

    <addColumn tableName="producto">
      <column name="marca_id" type="bigint"/>
    </addColumn>
  </changeSet>

  <!-- 3) Columna proveedor_id -->
  <changeSet id="0003-003-add-producto-proveedor-id" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists tableName="producto"/>
        <not>
          <columnExists tableName="producto" columnName="proveedor_id"/>
        </not>
      </and>
    </preConditions>

    <addColumn tableName="producto">
      <column name="proveedor_id" type="bigint"/>
    </addColumn>
  </changeSet>

  <!-- 4) FK categoria -->
  <changeSet id="0003-010-fk-producto-categoria" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists tableName="producto"/>
        <tableExists tableName="categoria"/>
        <columnExists tableName="producto" columnName="categoria_id"/>
        <not>
          <foreignKeyConstraintExists foreignKeyName="fk_producto_categoria"/>
        </not>
      </and>
    </preConditions>

    <addForeignKeyConstraint
      baseTableName="producto"
      baseColumnNames="categoria_id"
      referencedTableName="categoria"
      referencedColumnNames="id"
      constraintName="fk_producto_categoria"/>
  </changeSet>

  <!-- 5) FK marca -->
  <changeSet id="0003-011-fk-producto-marca" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists tableName="producto"/>
        <tableExists tableName="marca"/>
        <columnExists tableName="producto" columnName="marca_id"/>
        <not>
          <foreignKeyConstraintExists foreignKeyName="fk_producto_marca"/>
        </not>
      </and>
    </preConditions>

    <addForeignKeyConstraint
      baseTableName="producto"
      baseColumnNames="marca_id"
      referencedTableName="marca"
      referencedColumnNames="id"
      constraintName="fk_producto_marca"/>
  </changeSet>

  <!-- 6) FK proveedor -->
  <changeSet id="0003-012-fk-producto-proveedor" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists tableName="producto"/>
        <tableExists tableName="proveedor"/>
        <columnExists tableName="producto" columnName="proveedor_id"/>
        <not>
          <foreignKeyConstraintExists foreignKeyName="fk_producto_proveedor"/>
        </not>
      </and>
    </preConditions>

    <addForeignKeyConstraint
      baseTableName="producto"
      baseColumnNames="proveedor_id"
      referencedTableName="proveedor"
      referencedColumnNames="id"
      constraintName="fk_producto_proveedor"/>
  </changeSet>

</databaseChangeLog>
