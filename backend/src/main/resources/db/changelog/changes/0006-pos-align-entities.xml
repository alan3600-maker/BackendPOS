<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
    http://www.liquibase.org/xml/ns/dbchangelog
    https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.29.xsd">

  <!--
    Alineación POS con Entities:
    Sucursal.activo
    Caja.activo + codigo NOT NULL
    CajaTurno: fecha_apertura/fecha_cierre/monto_cierre_declarado + usuario_apertura_id NOT NULL
    created_at/updated_at NOT NULL (BaseEntity)
  -->

  <!-- 1) SUCURSAL: agregar activo (si falta) + timestamps NOT NULL -->
  <changeSet id="0006-001-sucursal-activo-and-timestamps" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="sucursal"/>
    </preConditions>

    <!-- activo (solo si falta) -->
    <addColumn tableName="sucursal">
      <column name="activo" type="boolean" defaultValueBoolean="true">
        <constraints nullable="false"/>
      </column>
    </addColumn>

    <!-- Si ya existe, Liquibase fallaría; por eso lo movemos a un changeSet separado -->
  </changeSet>

  <changeSet id="0006-001b-sucursal-activo-only-if-missing" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists tableName="sucursal"/>
        <not><columnExists tableName="sucursal" columnName="activo"/></not>
      </and>
    </preConditions>

    <addColumn tableName="sucursal">
      <column name="activo" type="boolean" defaultValueBoolean="true">
        <constraints nullable="false"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="0006-001c-sucursal-timestamps-not-null" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="sucursal"/>
    </preConditions>

    <update tableName="sucursal">
      <column name="created_at" valueComputed="now()"/>
      <where>created_at IS NULL</where>
    </update>
    <update tableName="sucursal">
      <column name="updated_at" valueComputed="now()"/>
      <where>updated_at IS NULL</where>
    </update>

    <addNotNullConstraint tableName="sucursal" columnName="created_at" columnDataType="timestamp with time zone"/>
    <addNotNullConstraint tableName="sucursal" columnName="updated_at" columnDataType="timestamp with time zone"/>
  </changeSet>

  <!-- 2) CAJA: renombrar activa->activo (solo si aplica) -->
  <changeSet id="0006-002-caja-rename-activa-a-activo" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists tableName="caja"/>
        <columnExists tableName="caja" columnName="activa"/>
        <not><columnExists tableName="caja" columnName="activo"/></not>
      </and>
    </preConditions>

    <renameColumn tableName="caja" oldColumnName="activa" newColumnName="activo" columnDataType="boolean"/>
  </changeSet>

  <!-- 2b) CAJA: codigo NOT NULL -->
  <changeSet id="0006-002b-caja-codigo-not-null" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="caja"/>
    </preConditions>

    <update tableName="caja">
      <column name="codigo" value=""/>
      <where>codigo IS NULL</where>
    </update>
    <addNotNullConstraint tableName="caja" columnName="codigo" columnDataType="varchar(60)"/>
  </changeSet>

  <!-- 2c) CAJA: timestamps NOT NULL -->
  <changeSet id="0006-002c-caja-timestamps-not-null" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="caja"/>
    </preConditions>

    <update tableName="caja">
      <column name="created_at" valueComputed="now()"/>
      <where>created_at IS NULL</where>
    </update>
    <update tableName="caja">
      <column name="updated_at" valueComputed="now()"/>
      <where>updated_at IS NULL</where>
    </update>

    <addNotNullConstraint tableName="caja" columnName="created_at" columnDataType="timestamp with time zone"/>
    <addNotNullConstraint tableName="caja" columnName="updated_at" columnDataType="timestamp with time zone"/>
  </changeSet>

  <!-- 3) CAJA_TURNO: renombres (cada rename en su changeSet para preConditions limpias) -->
  <changeSet id="0006-003a-caja_turno-rename-apertura" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists tableName="caja_turno"/>
        <columnExists tableName="caja_turno" columnName="apertura_at"/>
        <not><columnExists tableName="caja_turno" columnName="fecha_apertura"/></not>
      </and>
    </preConditions>

    <renameColumn tableName="caja_turno" oldColumnName="apertura_at" newColumnName="fecha_apertura"
                  columnDataType="timestamp with time zone"/>
  </changeSet>

  <changeSet id="0006-003b-caja_turno-rename-cierre" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists tableName="caja_turno"/>
        <columnExists tableName="caja_turno" columnName="cierre_at"/>
        <not><columnExists tableName="caja_turno" columnName="fecha_cierre"/></not>
      </and>
    </preConditions>

    <renameColumn tableName="caja_turno" oldColumnName="cierre_at" newColumnName="fecha_cierre"
                  columnDataType="timestamp with time zone"/>
  </changeSet>

  <changeSet id="0006-003c-caja_turno-rename-monto-final" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists tableName="caja_turno"/>
        <columnExists tableName="caja_turno" columnName="monto_final_declarado"/>
        <not><columnExists tableName="caja_turno" columnName="monto_cierre_declarado"/></not>
      </and>
    </preConditions>

    <renameColumn tableName="caja_turno" oldColumnName="monto_final_declarado" newColumnName="monto_cierre_declarado"
                  columnDataType="numeric(18,2)"/>
  </changeSet>

  <!-- 3d) CAJA_TURNO: timestamps NOT NULL -->
  <changeSet id="0006-003d-caja_turno-timestamps-not-null" author="hidraulica">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="caja_turno"/>
    </preConditions>

    <update tableName="caja_turno">
      <column name="created_at" valueComputed="now()"/>
      <where>created_at IS NULL</where>
    </update>
    <update tableName="caja_turno">
      <column name="updated_at" valueComputed="now()"/>
      <where>updated_at IS NULL</where>
    </update>

    <addNotNullConstraint tableName="caja_turno" columnName="created_at" columnDataType="timestamp with time zone"/>
    <addNotNullConstraint tableName="caja_turno" columnName="updated_at" columnDataType="timestamp with time zone"/>
  </changeSet>

  <!-- 4) CAJA_TURNO: usuario_apertura_id NOT NULL (solo si no hay nulls) -->
<changeSet id="0006-004-caja_turno-usuario_apertura-not-null" author="hidraulica">
  <preConditions onFail="MARK_RAN">
    <and>
      <tableExists tableName="caja_turno"/>
      <columnExists tableName="caja_turno" columnName="usuario_apertura_id"/>
      <sqlCheck expectedResult="0">
        SELECT COUNT(*) FROM caja_turno WHERE usuario_apertura_id IS NULL
      </sqlCheck>
    </and>
  </preConditions>

  <addNotNullConstraint tableName="caja_turno" columnName="usuario_apertura_id" columnDataType="bigint"/>
</changeSet>


</databaseChangeLog>
